global.CONNS=OBJECT({init:function(t,e,o){"use strict";var a,r=t.socketPack,i=[];o.addDisconnectListener=a=function(t){i.push(t)},r.on("connection",function(t){var e={};t.addListener("disconnect",function(){EACH(i,function(e){e(t.id)})}),t.emit("__CONNECTED",t.id),t.addListener("__ENTER_ROOM",function(o){void 0===e[o]?(t.join(o),e[o]=1):e[o]+=1}),t.addListener("__EXIT_ROOM",function(o){e[o]-=1,0===e[o]&&(t.leave(o),delete e[o])})})}}),FOR_BOX(function(t){"use strict";t.DB=CLASS({init:function(e,o,a,r){var i,n,d,c,v,f,s,u,E,m,D,S,h,l,_,g,O,R,p,C,A=UPPERSITE.MODULE("mongolian").ObjectId;SERVER_CONFIG.isNotUsingDB===!0?(a.createData=m=function(){},a.createDataSafely=D=function(){},a.getData=S=function(){},a.updateData=h=function(){},a.updateDataSafely=l=function(){},a.removeData=_=function(){},a.removeDataSafely=g=function(){},a.findData=O=function(){},a.findDataSet=R=function(){},a.countDataSet=p=function(){},a.checkIsExists=C=function(){}):(i=UPPERSITE.db.collection(t.boxName+"."+r),n=UPPERSITE.db.collection(t.boxName+"."+r+"_backup"),d=UPPERSITE.db.collection(t.boxName+"."+r+"_error"),c=function(t){return new A(t)},v=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,t},f=function(t){EACH(t,function(e,o){e===TO_DELETE?REMOVE_AT({data:t,key:o}):(CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0)&&f(e)})},s=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(e,o){CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0?EACH(e,function(t,o){e[o]=c(t)}):t.id[o]=c(e)}),t._id=t.id):t._id=c(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(e,o){void 0===e&&delete t[o]})},u=function(t){var e=t.call,o=t.data,a=new Date;n.save({call:e,time:a,data:o})},E=function(t){t.time=new Date,d.save(t)},a.createData=m=function(t,e){var o;try{t.__IS_ENABLED=!0,t.createTime=new Date,f(t),i.save(t),u({method:"createData",data:t}),void 0!==e&&(v(t),e(void 0,t))}catch(a){o=a.toString(),E({method:"createData",data:t,errorMsg:o}),void 0!==e&&e(o)}},a.createDataSafely=D=function(t,e){var o;try{t.__IS_ENABLED=!0,t.createTime=new Date,f(t),i.save(t,function(a,r){null===a?(u({method:"createDataSafely",data:r}),v(r),e(void 0,r)):(o=a.toString(),E({method:"createDataSafely",data:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"createDataSafely",data:t,errorMsg:o}),e(o)}},a.getData=S=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},i.findOne(o,function(o,r){null===o?(void 0!==r&&v(r),e(void 0,r)):(a=o.toString(),E({method:"getData",id:t,errorMsg:a}),e(a))})}catch(r){a=r.toString(),E({method:"getData",id:t,errorMsg:a}),e(a)}},a.updateData=h=function(t,e){var o,a,r=t.id;try{o={_id:c(r),__IS_ENABLED:!0},i.findOne(o,function(o,r){delete t.id,null===o?void 0===r?void 0!==e&&e():(EACH(r,function(e,o){(void 0===t[o]||"_id"===o||"__IS_ENABLED"===o||"createTime"===o)&&(t[o]=e)}),f(t),t.lastUpdateTime=new Date,i.save(t),u({method:"updateData",data:t}),void 0!==e&&(v(t),e(void 0,t))):(a=o.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==e&&e(a))})}catch(n){a=n.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==e&&e(a)}},a.updateDataSafely=l=function(t,e){var o,a,r=t.id;try{o={_id:c(r),__IS_ENABLED:!0},i.findOne(o,function(o,r){delete t.id,null===o?void 0===r?e():(EACH(r,function(e,o){(void 0===t[o]||"_id"===o||"__IS_ENABLED"===o||"createTime"===o)&&(t[o]=e)}),f(t),t.lastUpdateTime=new Date,i.save(t,function(o,r){null===o?(u({method:"updateDataSafely",data:r}),v(r),e(void 0,r)):(a=o.toString(),E({method:"updateDataSafely",data:t,errorMsg:a}),e(a))})):(a=o.toString(),E({method:"updateDataSafely",data:t,errorMsg:a}),e(a))})}catch(n){a=n.toString(),E({method:"updateDataSafely",data:t,errorMsg:a}),e(a)}},a.removeData=_=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},i.findOne(o,function(o,r){null===o?void 0===r?void 0!==e&&e():(r.__IS_ENABLED=!1,r.removeTime=new Date,i.save(r),u({method:"removeData",data:r}),void 0!==e&&(v(r),e(void 0,r))):(a=o.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==e&&e(a))})}catch(r){a=r.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==e&&e(a)}},a.removeDataSafely=g=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},i.findOne(o,function(o,r){null===o?void 0===r?e():(r.__IS_ENABLED=!1,r.removeTime=new Date,i.save(r,function(o,r){null===o?(u({method:"removeDataSafely",data:r}),v(r),e(void 0,r)):(a=o.toString(),E({method:"removeDataSafely",id:t,errorMsg:a}),e(a))})):(a=o.toString(),E({method:"removeDataSafely",id:t,errorMsg:a}),e(a))})}catch(r){a=r.toString(),E({method:"removeDataSafely",id:t,errorMsg:a}),e(a)}},a.findData=O=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{s(t),i.findOne(t,function(a,r){null===a?(void 0!==r&&v(r),e(void 0,r)):(o=a.toString(),E({method:"findData",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"findData",filter:t,errorMsg:o}),e(o)}},a.findDataSet=R=function(t,e){var o,a,r=void 0===t?void 0:t.filter,n=void 0===t?void 0:t.sort,d=void 0===t?void 0:t.start,c=void 0===t||void 0===t.count?void 0:parseInt(t.count,10),f=void 0===t||void 0===t.isFindAll?void 0:parseInt(t.isFindAll,10);void 0!==t&&void 0===e&&(e=t);try{void 0===r&&(r={}),void 0===n&&(n={}),void 0===d&&(d=0),f!==!0&&(void 0===c||c>SERVER_CONFIG.maxDataCount||isNaN(c)===!0?c=SERVER_CONFIG.maxDataCount:1>c&&(c=1)),s(r),a=function(a,r){null===a?(void 0!==r&&EACH(r,function(t){v(t)}),e(void 0,r)):(o=a.toString(),E({method:"findDataSet",params:t,errorMsg:o}),e(o))},f===!0?i.find(r).sort(n).skip(d).toArray(a):i.find(r).sort(n).skip(d).limit(c).toArray(a)}catch(u){o=u.toString(),E({method:"findDataSet",params:t,errorMsg:o}),e(o)}},a.countDataSet=p=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{s(t),i.find(t).count(function(a,r){null===a?e(void 0,r):(o=a.toString(),E({method:"countDataSet",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"countDataSet",filter:t,errorMsg:o}),e(o)}},a.checkIsExists=C=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{s(t),i.find(t).count(function(a,r){null===a?e(void 0,void 0!==r&&r>0):(o=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:o}),e(o)}})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(e,o,a,r){var i,n;SERVER_CONFIG.isNotUsingDB===!0?a.log=n=function(){}:(i=UPPERSITE.db.collection(t.boxName+"."+r),a.log=n=function(t){t.time=new Date,i.save(t)})}})}),FOR_BOX(function(t){"use strict";OVERRIDE(t.MODEL,function(){t.MODEL=CLASS({init:function(e,o,a,r){var i,n,d,c,v,f,s,u,E,m,D,S,h,l,_,g,O,R,p,C,A,M,N,I=r.name,b=void 0===r.propertyNamesForNewEvent?[]:r.propertyNamesForNewEvent,y=r.config,T=t.DB(I),U=t.ROOM(I),k=t.ROOM(I+"/{id}");void 0!==y&&(i=y.create,n=y.getData,d=y.update,c=y.remove,v=y.findData,f=y.findDataSet,s=y.countDataSet,u=y.checkIsExists,void 0!==i&&(E=i.valid),void 0!==d&&(m=d.valid)),o.getCreateValid=D=function(){return E},o.getUpdateValid=S=function(){return m},i!==!1&&U.on("create",function(e,a,r,i,n,d){var c,v=void 0===E?void 0:E.check({data:a});void 0!==v&&v.checkHasError()===!0?d({hasError:!0,errors:v.getErrors()}):(c=function(){T.createDataSafely(a,function(a,r){void 0!==a?d({hasError:!0,errorMsg:a}):(void 0!==o.afterCreate&&o.afterCreate(r),void 0!==o.afterCreateRoom&&o.afterCreateRoom({savedData:r,room:U,socketId:e,ip:i,headers:n}),t.ROOMS(I+"/create").broadcast({methodName:"create",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(I+"/"+e+"/"+o+"/create").broadcast({methodName:"create",data:r})}),d({hasError:!1,savedData:r}))})},void 0===o.beforeCreateRoom?void 0!==o.beforeCreate?o.beforeCreate(a,{ret:d,proc:c})!==!1&&c():c():o.beforeCreateRoom({data:a,room:U,socketId:e,ip:i,headers:n},{ret:d,proc:c}))}),d!==!1&&k.on("update",function(e,a,r,i,n,d){var c,v=r.id,f=void 0===m?void 0:m.check({data:a,isExceptUndefined:!0});a.id=v,void 0!==m&&f.checkHasError()===!0?d({hasError:!0,errors:f.getErrors()}):(c=function(){T.updateDataSafely(a,function(a,r){void 0!==a?d({hasError:!0,errorMsg:a}):(void 0!==r&&(void 0!==o.afterUpdate&&o.afterUpdate(r),void 0!==o.afterUpdateRoom&&o.afterUpdateRoom({savedData:r,room:k,socketId:e,ip:i,headers:n}),t.ROOMS(I+"/"+v).broadcast({methodName:"update",data:r})),d({hasError:!1,savedData:r}))})},void 0===o.beforeUpdateRoom?void 0!==o.beforeUpdate?o.beforeUpdate(a,{ret:d,proc:c})!==!1&&c():c():o.beforeUpdateRoom({data:a,room:k,socketId:e,ip:i,headers:n},{ret:d,proc:c})!==!1&&c())}),c!==!1&&k.on("remove",function(e,a,r,i,n,d){var c;c=function(){T.removeDataSafely(a,function(r,c){void 0!==r?d({hasError:!0,errorMsg:r}):(void 0!==c&&(void 0!==o.afterRemove&&o.afterRemove(c),void 0!==o.afterRemoveRoom&&o.afterRemoveRoom({savedData:c,room:k,socketId:e,ip:i,headers:n}),t.ROOMS(I+"/"+a).broadcast({methodName:"remove",data:c}),EACH(b,function(e){var o=c[e];t.ROOMS(I+"/"+e+"/"+o+"/remove").broadcast({methodName:"remove",data:c})})),d({hasError:!1,savedData:c}))})},void 0===o.beforeRemoveRoom?void 0!==o.beforeRemove?o.beforeRemove(a,{ret:d,proc:c})!==!1&&c():c():o.beforeRemoveRoom({id:a,room:k,socketId:e,ip:i,headers:n},{ret:d,proc:c})!==!1&&c()}),o.getDB=h=function(){return T},o.getRoom=l=function(){return U},i!==!1&&(a.create=_=function(e,a){var r,i=void 0===E?void 0:E.check({data:e});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){T.createDataSafely(e,function(e,r){void 0!==e?void 0!==a&&a({hasError:!0,errorMsg:e}):(void 0!==o.afterCreate&&o.afterCreate(r),t.ROOMS(I+"/create").broadcast({methodName:"create",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(I+"/"+e+"/"+o+"/create").broadcast({methodName:"create",data:r})}),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==o.beforeCreate?o.beforeCreate(e,{ret:a,proc:r})!==!1&&r():r())}),n!==!1&&(a.getData=g=function(t,e){T.getData(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.getData||o.getData(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedData:a})})}),d!==!1&&(a.update=O=function(e,a){var r,i=void 0===m?void 0:m.check({data:e,isExceptUndefined:!0});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){T.updateDataSafely(e,function(r,i){void 0!==r?void 0!==a&&a({hasError:!0,errorMsg:r}):(void 0!==i&&(void 0!==o.afterUpdate&&o.afterUpdate(i),t.ROOMS(I+"/"+e.id).broadcast({methodName:"update",data:i})),void 0!==a&&a({hasError:!1,savedData:i}))})},void 0!==o.beforeUpdate?o.beforeUpdate(e,{ret:a,proc:r})!==!1&&r():r())}),c!==!1&&(a.remove=R=function(e,a){var r;r=function(){T.removeDataSafely(e,function(e,r){void 0!==e?void 0!==a&&a({hasError:!0,errorMsg:e}):(void 0!==r&&(void 0!==o.afterRemove&&o.afterRemove(r),t.ROOMS(I+"/"+r.id).broadcast({methodName:"remove",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(I+"/"+e+"/"+o+"/remove").broadcast({methodName:"remove",data:r})})),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==o.beforeRemove?o.beforeRemove(e,{ret:a,proc:r})!==!1&&r():r()}),v!==!1&&(a.findData=p=function(t,e){T.findData(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.findData||o.findData(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedData:a})})}),f!==!1&&(a.findDataSet=C=function(t,e){T.findDataSet(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.findDataSet||o.findDataSet(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedDataSet:a})})}),s!==!1&&(a.countDataSet=A=function(t,e){T.countDataSet(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.countDataSet||o.countDataSet(a,e)!==!1)&&void 0!==e&&e({hasError:!1,count:a})})}),u!==!1&&(a.checkIsExists=M=function(t,e){T.checkIsExists(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.checkIsExists||o.checkIsExists(a,e)!==!1)&&void 0!==e&&e({hasError:!1,isExists:a})})}),n!==!1&&U.on("getData",function(t,e,o,a,r,i){g(e,i)}),v!==!1&&U.on("findData",function(t,e,o,a,r,i){p(e,i)}),f!==!1&&U.on("findDataSet",function(t,e,o,a,r,i){delete e.isFindAll,C(e,i)}),s!==!1&&U.on("countDataSet",function(t,e,o,a,r,i){A(e,i)}),u!==!1&&U.on("checkIsExists",function(t,e,o,a,r,i){M(e,i)}),o.getName=N=function(){return I}}})})}),FOR_BOX(function(t){"use strict";t.MODULE=METHOD({run:function(e,o){var a=__dirname+"/../..";return require(a+"/"+t.boxName+"/SERVER/node_modules/"+o)}})}),FOR_BOX(function(t){"use strict";t.REQUEST=METHOD({statics:function(t){t.funcs={},t.checkURI=function(e,o){var a=e.uri,r=e.paramStr,i=e.ip,n=e.headers,d=o.response,c=o.serveErrorPage;return EACH(t.funcs,function(t,e){var o,v="",f=e,s={};return o=function(t){var e,o;return-1!==f.indexOf("{")&&-1!==f.indexOf("}")&&(o=f.substring(0,f.indexOf("{")),v+"/"===o)?(e=f.substring(f.indexOf("{")+1,f.indexOf("}")),f=o+t+f.substring(f.indexOf("}")+1),{name:e,value:t}):void 0},EACH(a.split("/"),function(t,e){var a=o(t);return void 0!==a&&(s[a.name]=a.value),0===e?v=t:v+="/"+t,v===f?!1:void 0}),a===f?(t(r,s,i,n,d,c),!1):void 0})===!1}},run:function(t,e,o){t.funcs[e]=o}})}),FOR_BOX(function(t){"use strict";t.REQUEST_JSON=METHOD({run:function(e,o,a){t.REQUEST.funcs[o]=function(t,e,o,r,i,n){var d;try{d=JSON.parse(t)}catch(c){return void n()}return a(d,e,o,r,i,n)}}})}),FOR_BOX(function(t){"use strict";t.ROOM=CLASS({init:function(e,o,a,r){var i,n;a.on=i=function(e,o){t.REQUEST_JSON("__FOR_ROOM/"+r+"/"+e,function(t,e,a,r,i){t=UNPACK_DATA(t),o(t.socketId,t.data,e,a,r,function(t){i({content:JSON.stringify(CHECK_IS_DATA(t)===!0?PACK_DATA(t):t),contentType:"application/json",encoding:"utf-8"})})})},a.addDisconnectListener=n=function(t){CONNS.addDisconnectListener(t)}}})}),FOR_BOX(function(t){"use strict";t.ROOMS=CLASS({init:function(e,o,a,r){var i,n=t.boxName+"/"+r;a.broadcast=i=function(t){var e=t.methodName,o=CHECK_IS_DATA(t.data)===!0?PACK_DATA(t.data):t.data,a=n+"/"+e;CONNS.type.socketPack["in"](n).emit(a,o)}}})}),global.SERVER_CONFIG={dbName:"UPPERSITE-testdb",dbUsername:"test",dbPassword:"test",maxDataCount:1e3,errorPageUrl:"/UPPERSITE/ERROR.html"},global.SHA1=METHOD({run:function(t,e){"use strict";var o=e.key,a=e.password,r=require("crypto");return r.createHmac("sha1",o).update(a).digest("hex")}}),global.TIME_SYNC=OBJECT({init:function(){"use strict";var t=UPPERSITE.ROOM("timeSync");t.on("sync",function(t,e,o,a,r,i){var n=new Date,d=e.now;i({diff:d-n})})}});