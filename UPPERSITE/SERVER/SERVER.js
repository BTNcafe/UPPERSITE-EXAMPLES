global.CONNS=CONNS=OBJECT({init:function(t,o,e){"use strict";var a,r=t.socketPack,i=[];e.addDisconnectListener=a=function(t){i.push(t)},r.on("connection",function(t){var o={};t.addListener("disconnect",function(){EACH(i,function(o){o(t.id)})}),t.emit("__CONNECTED",t.id),t.addListener("__ENTER_ROOM",function(e){void 0===o[e]?(t.join(e),o[e]=1):o[e]+=1}),t.addListener("__EXIT_ROOM",function(e){o[e]-=1,0===o[e]&&(t.leave(e),delete o[e])})})}}),FOR_BOX(function(t){"use strict";t.DB=CLASS({init:function(o,e,a,r){var i,n,d,c,s,v,f,u,E,m,D,S,R,h,O,_,g,l=UPPERSITE.MODULE("mongolian").ObjectId;SERVER_CONFIG.isNotUsingDB===!0?(a.createData=m=function(){},a.getData=D=function(){},a.updateData=S=function(){},a.removeData=R=function(){},a.findData=h=function(){},a.findDataSet=O=function(){},a.countDataSet=_=function(){},a.checkIsExists=g=function(){}):(i=UPPERSITE.db.collection(t.boxName+"."+r),n=UPPERSITE.db.collection(t.boxName+"."+r+"__BACKUP"),d=UPPERSITE.db.collection(t.boxName+"."+r+"__ERROR"),c=function(t){return new l(t)},s=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,t},v=function(t){EACH(t,function(o,e){o===TO_DELETE?REMOVE_AT({data:t,key:e}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&v(o)})},f=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,e){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,e){o[e]=c(t)}):t.id[e]=c(o)}),t._id=t.id):t._id=c(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(o,e){void 0===o&&delete t[e]})},u=function(t){var o=t.method,e=t.data,a=new Date,r={method:o,time:a,data:e};n.save(r),SERVER_CONFIG.isDBLogMode===!0&&console.log("[DB SAVED]",r)},E=function(t){t.time=new Date,d.save(t),SERVER_CONFIG.isDBLogMode===!0&&console.log("[DB ERROR]",t)},a.createData=m=function(t,o){var e;try{t.__IS_ENABLED=!0,t.createTime=new Date,v(t),i.save(t,function(a,r){null===a?(u({method:"createData",data:r}),s(r),void 0!==o&&o(void 0,r)):(e=a.toString(),E({method:"createData",data:t,errorMsg:e}),void 0!==o&&o(e))})}catch(a){e=a.toString(),E({method:"createData",data:t,errorMsg:e}),void 0!==o&&o(e)}},a.getData=D=function(t,o){var e,a;try{e={_id:c(t),__IS_ENABLED:!0},i.findOne(e,function(e,r){null===e?(void 0!==r&&s(r),o(void 0,r)):(a=e.toString(),E({method:"getData",id:t,errorMsg:a}),o(a))})}catch(r){a=r.toString(),E({method:"getData",id:t,errorMsg:a}),o(a)}},a.updateData=S=function(t,o){var e,a,r=t.id;try{e={_id:c(r),__IS_ENABLED:!0},i.findOne(e,function(e,r){delete t.id,null===e?void 0===r?void 0!==o&&o():(EACH(r,function(o,e){(void 0===t[e]||"_id"===e||"__IS_ENABLED"===e||"createTime"===e)&&(t[e]=o)}),v(t),t.lastUpdateTime=new Date,i.save(t,function(e,r){null===e?(u({method:"updateData",data:r}),s(r),void 0!==o&&o(void 0,r)):(a=e.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==o&&o(a))})):(a=e.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==o&&o(a))})}catch(n){a=n.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==o&&o(a)}},a.removeData=R=function(t,o){var e,a;try{e={_id:c(t),__IS_ENABLED:!0},i.findOne(e,function(e,r){null===e?void 0===r?void 0!==o&&o():(r.__IS_ENABLED=!1,r.removeTime=new Date,i.save(r,function(e,r){null===e?(u({method:"removeData",data:r}),s(r),void 0!==o&&o(void 0,r)):(a=e.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==o&&o(a))})):(a=e.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==o&&o(a))})}catch(r){a=r.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==o&&o(a)}},a.findData=h=function(t,o){var e;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{f(t),i.findOne(t,function(a,r){null===a?(void 0!==r&&s(r),o(void 0,r)):(e=a.toString(),E({method:"findData",filter:t,errorMsg:e}),o(e))})}catch(a){e=a.toString(),E({method:"findData",filter:t,errorMsg:e}),o(e)}},a.findDataSet=O=function(t,o){var e,a,r=void 0===t?void 0:t.filter,n=void 0===t?void 0:t.sort,d=void 0===t?void 0:t.start,c=void 0===t||void 0===t.count?void 0:INTEGER(t.count),v=void 0===t||void 0===t.isFindAll?void 0:INTEGER(t.isFindAll);void 0!==t&&void 0===o&&(o=t);try{void 0===r&&(r={}),void 0===n&&(n={}),void 0===d&&(d=0),v!==!0&&(void 0===c||c>SERVER_CONFIG.maxDataCount||isNaN(c)===!0?c=SERVER_CONFIG.maxDataCount:1>c&&(c=1)),f(r),a=function(a,r){null===a?(void 0!==r&&EACH(r,function(t){s(t)}),o(void 0,r)):(e=a.toString(),E({method:"findDataSet",params:t,errorMsg:e}),o(e))},v===!0?i.find(r).sort(n).skip(d).toArray(a):i.find(r).sort(n).skip(d).limit(c).toArray(a)}catch(u){e=u.toString(),E({method:"findDataSet",params:t,errorMsg:e}),o(e)}},a.countDataSet=_=function(t,o){var e;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{f(t),i.find(t).count(function(a,r){null===a?o(void 0,r):(e=a.toString(),E({method:"countDataSet",filter:t,errorMsg:e}),o(e))})}catch(a){e=a.toString(),E({method:"countDataSet",filter:t,errorMsg:e}),o(e)}},a.checkIsExists=g=function(t,o){var e;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{f(t),i.find(t).count(function(a,r){null===a?o(void 0,void 0!==r&&r>0):(e=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:e}),o(e))})}catch(a){e=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:e}),o(e)}})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(o,e,a,r){var i,n;SERVER_CONFIG.isNotUsingDB===!0?a.log=n=function(){}:(i=UPPERSITE.db.collection(t.boxName+"."+r),a.log=n=function(t){t.time=new Date,i.save(t)})}})}),FOR_BOX(function(t){"use strict";OVERRIDE(t.MODEL,function(){t.MODEL=CLASS({init:function(o,e,a,r){var i,n,d,c,s,v,f,u,E,m,D,S,R,h,O,_,g,l,C,N,M,p,A,b=r.name,I=void 0===r.propertyNamesForNewEvent?[]:r.propertyNamesForNewEvent,T=r.config,U=t.DB(b),H=t.ROOM(b),k=t.ROOM(b+"/{id}");void 0!==T&&(i=T.create,n=T.getData,d=T.update,c=T.remove,s=T.findData,v=T.findDataSet,f=T.countDataSet,u=T.checkIsExists,void 0!==i&&(E=i.valid),void 0!==d&&(m=d.valid)),e.getCreateValid=D=function(){return E},e.getUpdateValid=S=function(){return m},i!==!1&&H.on("create",function(o,a,r,i){var n,d=void 0===E?void 0:E.check({data:a});void 0!==d&&d.checkHasError()===!0?i({hasError:!0,errors:d.getErrors()}):(n=function(){U.createData(a,function(o,a){void 0!==o?i({hasError:!0,errorMsg:o}):(void 0!==e.afterCreate&&e.afterCreate(a),void 0!==e.afterCreateRoom&&e.afterCreateRoom({room:H,savedData:a,headers:r}),t.ROOMS(b+"/create").broadcast({methodName:"create",data:a}),EACH(I,function(o){var e=a[o];t.ROOMS(b+"/"+o+"/"+e+"/create").broadcast({methodName:"create",data:a})}),i({hasError:!1,savedData:a}))})},void 0===e.beforeCreateRoom?void 0!==e.beforeCreate?e.beforeCreate(a,{ret:i,proc:n})!==!1&&n():n():e.beforeCreateRoom({room:H,data:a,headers:r},{ret:i,proc:n}))}),d!==!1&&k.on("update",function(o,a,r,i){var n,d=o.id,c=void 0===m?void 0:m.check({data:a,isExceptUndefined:!0});a.id=d,void 0!==m&&c.checkHasError()===!0?i({hasError:!0,errors:c.getErrors()}):(n=function(){U.updateData(a,function(o,a){void 0!==o?i({hasError:!0,errorMsg:o}):(void 0!==a&&(void 0!==e.afterUpdate&&e.afterUpdate(a),void 0!==e.afterUpdateRoom&&e.afterUpdateRoom({room:k,savedData:a,headers:r}),t.ROOMS(b+"/"+d).broadcast({methodName:"update",data:a})),i({hasError:!1,savedData:a}))})},void 0===e.beforeUpdateRoom?void 0!==e.beforeUpdate?e.beforeUpdate(a,{ret:i,proc:n})!==!1&&n():n():e.beforeUpdateRoom({room:k,data:a,headers:r},{ret:i,proc:n})!==!1&&n())}),c!==!1&&k.on("remove",function(o,a,r,i){var n;n=function(){U.removeData(a,function(o,n){void 0!==o?i({hasError:!0,errorMsg:o}):(void 0!==n&&(void 0!==e.afterRemove&&e.afterRemove(n),void 0!==e.afterRemoveRoom&&e.afterRemoveRoom({room:k,savedData:n,headers:r}),t.ROOMS(b+"/"+a).broadcast({methodName:"remove",data:n}),EACH(I,function(o){var e=n[o];t.ROOMS(b+"/"+o+"/"+e+"/remove").broadcast({methodName:"remove",data:n})})),i({hasError:!1,savedData:n}))})},void 0===e.beforeRemoveRoom?void 0!==e.beforeRemove?e.beforeRemove(a,{ret:i,proc:n})!==!1&&n():n():e.beforeRemoveRoom({room:roomForRemove,id:a,headers:r},{ret:i,proc:n})!==!1&&n()}),e.getDB=R=function(){return U},e.getRoom=h=function(){return H},i!==!1&&(a.create=O=function(o,a){var r,i=void 0===E?void 0:E.check({data:o});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){U.createData(o,function(o,r){void 0!==o?void 0!==a&&a({hasError:!0,errorMsg:o}):(void 0!==e.afterCreate&&e.afterCreate(r),t.ROOMS(b+"/create").broadcast({methodName:"create",data:r}),EACH(I,function(o){var e=r[o];t.ROOMS(b+"/"+o+"/"+e+"/create").broadcast({methodName:"create",data:r})}),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==e.beforeCreate?e.beforeCreate(o,{ret:a,proc:r})!==!1&&r():r())}),n!==!1&&(a.getData=_=function(t,o){U.getData(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.getData||e.getData(a,o)!==!1)&&void 0!==o&&o({hasError:!1,savedData:a})})}),d!==!1&&(a.update=g=function(o,a){var r,i=void 0===m?void 0:m.check({data:o,isExceptUndefined:!0});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){U.updateData(o,function(r,i){void 0!==r?void 0!==a&&a({hasError:!0,errorMsg:r}):(void 0!==i&&(void 0!==e.afterUpdate&&e.afterUpdate(i),t.ROOMS(b+"/"+o.id).broadcast({methodName:"update",data:i})),void 0!==a&&a({hasError:!1,savedData:i}))})},void 0!==e.beforeUpdate?e.beforeUpdate(o,{ret:a,proc:r})!==!1&&r():r())}),c!==!1&&(a.remove=l=function(o,a){var r;r=function(){U.removeData(o,function(o,r){void 0!==o?void 0!==a&&a({hasError:!0,errorMsg:o}):(void 0!==r&&(void 0!==e.afterRemove&&e.afterRemove(r),t.ROOMS(b+"/"+r.id).broadcast({methodName:"remove",data:r}),EACH(I,function(o){var e=r[o];t.ROOMS(b+"/"+o+"/"+e+"/remove").broadcast({methodName:"remove",data:r})})),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==e.beforeRemove?e.beforeRemove(o,{ret:a,proc:r})!==!1&&r():r()}),s!==!1&&(a.findData=C=function(t,o){U.findData(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.findData||e.findData(a,o)!==!1)&&void 0!==o&&o({hasError:!1,savedData:a})})}),v!==!1&&(a.findDataSet=N=function(t,o){U.findDataSet(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.findDataSet||e.findDataSet(a,o)!==!1)&&void 0!==o&&o({hasError:!1,savedDataSet:a})})}),f!==!1&&(a.countDataSet=M=function(t,o){U.countDataSet(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.countDataSet||e.countDataSet(a,o)!==!1)&&void 0!==o&&o({hasError:!1,count:a})})}),u!==!1&&(a.checkIsExists=p=function(t,o){U.checkIsExists(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.checkIsExists||e.checkIsExists(a,o)!==!1)&&void 0!==o&&o({hasError:!1,isExists:a})})}),n!==!1&&H.on("getData",function(t,o,e,a){_(o,a)}),s!==!1&&H.on("findData",function(t,o,e,a){C(o,a)}),v!==!1&&H.on("findDataSet",function(t,o,e,a){delete t.isFindAll,N(o,a)}),f!==!1&&H.on("countDataSet",function(t,o,e,a,r){M(o,r)}),u!==!1&&H.on("checkIsExists",function(t,o,e,a,r){p(o,r)}),e.getName=A=function(){return b}}})})}),FOR_BOX(function(t){"use strict";t.MODULE=METHOD({run:function(o,e){var a=__dirname+"/../..";return require(a+"/"+t.boxName+"/SERVER/node_modules/"+e)}})}),FOR_BOX(function(t){"use strict";t.REQUEST=METHOD({statics:function(t){t.funcs={},t.checkURI=function(o,e){var a=o.uri,r=o.paramStr,i=(o.ip,o.headers),n=o.method,d=e.response,c=e.serveErrorPage;return EACH(t.funcs,function(t,o){var e,s="",v=o,f={};return e=function(t){var o,e;return-1!==v.indexOf("{")&&-1!==v.indexOf("}")&&(e=v.substring(0,v.indexOf("{")),s+"/"===e)?(o=v.substring(v.indexOf("{")+1,v.indexOf("}")),v=e+t+v.substring(v.indexOf("}")+1),{name:o,value:t}):void 0},EACH(a.split("/"),function(t,o){var a=e(t);return void 0!==a&&(f[a.name]=a.value),0===o?s=t:s+="/"+t,s===v?!1:void 0}),a===v?(t(n,f,r,i,d,c),!1):void 0})===!1}},run:function(t,o,e){t.funcs[o]=e}})}),FOR_BOX(function(t){"use strict";t.REQUEST_JSON=METHOD({run:function(o,e,a){t.REQUEST.funcs[e]=function(t,o,e,r,i,n){var d;try{d=UNPACK_DATA(JSON.parse(e))}catch(c){return void n()}return a(t,o,d,r,i,n)}}})}),FOR_BOX(function(t){"use strict";t.ROOM=CLASS({init:function(o,e,a,r){var i,n;a.on=i=function(o,e){t.REQUEST_JSON("__FOR_ROOM/"+r+"/"+o,function(t,o,a,r,i){r.socketId=a.socketId,e(o,a.data,r,function(t){i({content:JSON.stringify(CHECK_IS_DATA(t)===!0?PACK_DATA(t):t),contentType:"application/json",encoding:"utf-8"})})})},a.addDisconnectListener=n=function(t){CONNS.addDisconnectListener(t)}}})}),FOR_BOX(function(t){"use strict";t.ROOMS=CLASS({init:function(o,e,a,r){var i,n=t.boxName+"/"+r;a.broadcast=i=function(t){var o=t.methodName,e=CHECK_IS_DATA(t.data)===!0?PACK_DATA(t.data):t.data,a=n+"/"+o;CONNS.type.socketPack["in"](n).emit(a,e)}}})}),global.SERVER_CONFIG=SERVER_CONFIG={dbName:"UPPERSITE-testdb",dbUsername:"test",dbPassword:"test",maxDataCount:1e3,errorPageUrl:"/UPPERSITE/ERROR.html"},global.SHA1=SHA1=METHOD({run:function(t,o){"use strict";var e=o.key,a=o.password,r=require("crypto");return r.createHmac("sha1",e).update(a).digest("hex")}}),global.TIME_SYNC=TIME_SYNC=OBJECT({init:function(){"use strict";var t=UPPERSITE.ROOM("timeSync");t.on("sync",function(t,o,e,a){var r=new Date,i=o.now;a({diff:i-r})})}});