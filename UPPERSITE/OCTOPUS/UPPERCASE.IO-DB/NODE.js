global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD({run:function(o,t,i){"use strict";var e=t.username,n=t.password,d=void 0===t.host?"127.0.0.1":t.host,r=void 0===t.port?27017:t.port,E=t.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==e&&void 0!==n?e+":"+n+"@":"")+d+":"+r+"/"+E,function(t,e){t!==TO_DELETE?console.log("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED:",t):(o.nativeDB=e,i())})}}),FOR_BOX(function(o){"use strict";o.DB=CLASS({init:function(t,i,e,n){var d,r,E,a,_,c,v,D,s=require("mongodb").ObjectID,u=CONNECT_TO_DB_SERVER.nativeDB,f=u.collection(o.boxName+"."+n),O=u.collection(o.boxName+"."+n+"__BACKUP"),m=u.collection(o.boxName+"."+n+"__ERROR"),T=function(o){return new s(o)},g=function(o){return void 0!==o._id&&(o.id=o._id.toString()),delete o._id,delete o.__IS_ENABLED,delete o.__RANDOM_KEY,o},A=function(o){EACH(o,function(t,i){t===TO_DELETE?REMOVE_AT({data:o,key:i}):(CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0)&&A(t)})},C=function(o){void 0!==o.id&&(CHECK_IS_DATA(o.id)===!0?(EACH(o.id,function(t,i){CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0?EACH(t,function(o,i){t[i]=T(o)}):o.id[i]=T(t)}),o._id=o.id):o._id=T(id),delete o.id),o.__IS_ENABLED=!0,EACH(o,function(t,i){void 0===t&&delete o[i]})},l=function(o){var t=o.method,i=o.data,e=new Date,n={method:t,time:e,data:i};O.save(n,function(){}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] DATA SAVED:",n)},S=function(o){o.time=new Date,m.save(o,function(){}),console.log("[UPPERCASE.IO-DB] ERROR:",o)};e.create=d=function(o,t){var i;try{o.__IS_ENABLED=!0,o.__RANDOM_KEY=Math.random(),o.createTime=new Date,A(o),f.save(o,function(e,n){e===TO_DELETE?(l({method:"create",data:n}),g(n),void 0!==t&&t(void 0,n)):(i=e.toString(),S({method:"create",data:o,errorMsg:i}),void 0!==t&&t(i))})}catch(e){i=e.toString(),S({method:"create",data:o,errorMsg:i}),void 0!==t&&t(i)}},r=function(o,t){var i,e=o.filter,n=o.sort;try{C(e),f.find(e).sort(n).limit(1).toArray(function(e,n){var d;e===TO_DELETE?(n!==TO_DELETE&&n.length>0&&(d=n[0],g(d)),t(void 0,d)):(i=e.toString(),S({method:"get",params:o,errorMsg:i}),t(i))})}catch(d){i=d.toString(),S({method:"get",params:o,errorMsg:i}),t(i)}},e.get=E=function(o,t){var i,e,n,d;void 0!==o&&void 0===t&&(t=o,o=void 0),CHECK_IS_DATA(o)===!0?(i=o.filter,e=o.sort,n=o.isRandom):i=void 0!==o?{_id:T(o)}:{},void 0===i&&(i={}),void 0===e&&(e={createTime:1}),n===!0?(i.__RANDOM_KEY={$gte:d=Math.random()},e.__RANDOM_KEY=1,r({filter:i,sort:e},function(o,n){void 0===o&&void 0===n?(i.__RANDOM_KEY={$lte:d},r({filter:i,sort:e},t)):t(o,n)})):r({filter:i,sort:e},t)},e.update=a=function(o,t){var i,e,n=o.id;try{i={_id:T(n),__IS_ENABLED:!0},f.findOne(i,function(i,n){i===TO_DELETE?n===TO_DELETE?void 0!==t&&t():(EACH(o,function(o,t){"id"!==t&&"_id"!==t&&"__IS_ENABLED"!==t&&"createTime"!==t&&(n[t]=o)}),A(n),n.lastUpdateTime=new Date,f.save(n,function(i){i===TO_DELETE?(l({method:"update",data:n}),g(n),void 0!==t&&t(void 0,n)):(e=i.toString(),S({method:"update",data:o,errorMsg:e}),void 0!==t&&t(e))})):(e=i.toString(),S({method:"update",data:o,errorMsg:e}),void 0!==t&&t(e))})}catch(d){e=d.toString(),S({method:"update",data:o,errorMsg:e}),void 0!==t&&t(e)}},e.remove=_=function(o,t){var i,e;try{i={_id:T(o),__IS_ENABLED:!0},f.findOne(i,function(i,n){i===TO_DELETE?n===TO_DELETE?void 0!==t&&t():(n.__IS_ENABLED=!1,n.removeTime=new Date,f.save(n,function(i){i===TO_DELETE?(l({method:"remove",data:n}),g(n),void 0!==t&&t(void 0,n)):(e=i.toString(),S({method:"remove",id:o,errorMsg:e}),void 0!==t&&t(e))})):(e=i.toString(),S({method:"remove",id:o,errorMsg:e}),void 0!==t&&t(e))})}catch(n){e=n.toString(),S({method:"remove",id:o,errorMsg:e}),void 0!==t&&t(e)}},e.find=c=function(o,t){var i,e,n=void 0===o?void 0:o.filter,d=void 0===o?void 0:o.sort,r=void 0===o?void 0:o.start,E=void 0===o||void 0===o.count?void 0:INTEGER(o.count),a=void 0===o||void 0===o.isFindAll?void 0:INTEGER(o.isFindAll);void 0!==o&&void 0===t&&(t=o);try{void 0===n&&(n={}),void 0===d&&(d={createTime:1}),void 0===r&&(r=0),a!==!0&&(void 0===E||E>NODE_CONFIG.maxDataCount||isNaN(E)===!0?E=NODE_CONFIG.maxDataCount:1>E&&(E=1)),C(n),e=function(e,n){e===TO_DELETE?(n!==TO_DELETE&&EACH(n,function(o){g(o)}),t(void 0,n)):(i=e.toString(),S({method:"find",params:o,errorMsg:i}),t(i))},a===!0?f.find(n).sort(d).skip(r).toArray(e):f.find(n).sort(d).skip(r).limit(E).toArray(e)}catch(_){i=_.toString(),S({method:"find",params:o,errorMsg:i}),t(i)}},e.count=v=function(o,t){var i;void 0!==o&&void 0===t&&(t=o),void 0===o&&(o={});try{C(o),f.find(o).count(function(e,n){e===TO_DELETE?t(void 0,n):(i=e.toString(),S({method:"count",filter:o,errorMsg:i}),t(i))})}catch(e){i=e.toString(),S({method:"count",filter:o,errorMsg:i}),t(i)}},e.checkIsExists=D=function(o,t){var i;void 0!==o&&void 0===t&&(t=o),void 0===o?o={}:CHECK_IS_DATA(o)!==!0&&(o={_id:T(o)});try{C(o),f.find(o).count(function(e,n){e===TO_DELETE?t(void 0,void 0!==n&&n>0):(i=e.toString(),S({method:"checkIsExists",filter:o,errorMsg:i}),t(i))})}catch(e){i=e.toString(),S({method:"checkIsExists",filter:o,errorMsg:i}),t(i)}}}})}),FOR_BOX(function(o){"use strict";o.LOG_DB=CLASS({init:function(t,i,e,n){var d,r=CONNECT_TO_DB_SERVER.nativeDB,E=r.collection(o.boxName+"."+n);e.log=d=function(o){o.time=new Date,E.save(o,function(){})}}})}),OVERRIDE(NODE_CONFIG,function(o){global.NODE_CONFIG=NODE_CONFIG=COMBINE_DATA({origin:o,extend:{isDBLogMode:!1,maxDataCount:1e3}})});