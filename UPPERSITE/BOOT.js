global.BOOT=BOOT=function(params){"use strict";var cluster=require("cluster"),version=Date.now(),cpuCount=require("os").cpus().length,i,work=function(sharedData){var fs=require("fs"),path=require("path"),MULTI_LANG_SUPPORT=params.MULTI_LANG_SUPPORT,rootPath=__dirname+"/..",browserScript="\nglobal = window;\n",logoText,stringifyJSONWithFunction,loadAll,startServer,startREPL;stringifyJSONWithFunction=function(data){return JSON.stringify(data,function(t,e){return"function"==typeof e?"__THIS_IS_FUNCTION_START__"+e.toString()+"__THIS_IS_FUNCTION_END__":e},"	").replace(/("__THIS_IS_FUNCTION_START__(.*)__THIS_IS_FUNCTION_END__")/g,function(match,content){return eval("("+eval('"'+content.substring('"__THIS_IS_FUNCTION_START__'.length,content.length-'__THIS_IS_FUNCTION_END__"'.length)+'"')+")").toString()})},loadAll=function(){var t,e,n,o,r,i,a,s,c,l,E,f,d;t=function(t){var e=t.path,n=t.name;return fs.statSync(rootPath+"/"+e).isDirectory()===!0&&"."!==n[0]&&"node_modules"!==n&&"not_load"!==n&&"deprecated"!==n&&"_"!==n[0]},e=function(){fs.readdirSync(rootPath).forEach(function(e){var n,o,r,i,a;if(t({path:e,name:e})===!0)if(o=e.split("."),1===o.length)global[e]=BOX(e),browserScript+="global."+e+" = "+e+" = BOX('"+e+"');\n";else for(i=global,a="",n=0;n<o.length;n+=1)r=o[n],a+=(""===a?"":".")+r,n<o.length-1?(i=void 0!==i[r]?i[r]:i[r]={},browserScript+="if (global."+a+" === undefined) { global."+a+" = "+a+" = {}; }\n"):(i[r]=BOX(e),browserScript+="global."+a+" = "+a+" = BOX('"+e+"');\n")})},n=function(t){var e,n,o,r=rootPath+"/"+t,i=path.extname(t);if(r.substring(0,(rootPath+"/UPPERSITE").length)!==rootPath+"/UPPERSITE")for(e in MULTI_LANG_SUPPORT)if(MULTI_LANG_SUPPORT.hasOwnProperty(e)===!0&&i==="."+e)return n="//"+fs.statSync(r).mtime.getTime(),(fs.existsSync(r+".__UPPERSITE_COMPILED")===!1||fs.readFileSync(r+".__UPPERSITE_COMPILED").toString().substring(0,n.length)!==n)&&(o=n+"\n"+MULTI_LANG_SUPPORT[e](fs.readFileSync(r).toString(),r),fs.writeFileSync(r+".__UPPERSITE_COMPILED",o)),void require(r+".__UPPERSITE_COMPILED");".js"===i||".JS"===i?require(r):".__UPPERSITE_COMPILED"===i&&fs.existsSync(r.substring(0,r.length-".__UPPERSITE_COMPILED".length))===!1&&fs.unlinkSync(r)},o=function(t){var e,n,o,r=rootPath+"/"+t,i=path.extname(t);if(r.substring(0,(rootPath+"/UPPERSITE").length)!==rootPath+"/UPPERSITE")for(e in MULTI_LANG_SUPPORT)if(MULTI_LANG_SUPPORT.hasOwnProperty(e)===!0&&i==="."+e)return n="//"+fs.statSync(r).mtime.getTime(),fs.existsSync(r+".__UPPERSITE_COMPILED")===!1||fs.readFileSync(r+".__UPPERSITE_COMPILED").toString().substring(0,n.length)!==n?(o=n+"\n"+MULTI_LANG_SUPPORT[e](fs.readFileSync(r).toString(),r),fs.writeFileSync(r+".__UPPERSITE_COMPILED",o)):o=fs.readFileSync(r+".__UPPERSITE_COMPILED").toString(),void(browserScript+=o+"\n");".js"===i||".JS"===i?(o=fs.readFileSync(r).toString(),browserScript+=o+"\n"):".__UPPERSITE_COMPILED"===i&&fs.existsSync(r.substring(0,r.length-".__UPPERSITE_COMPILED".length))===!1&&fs.unlinkSync(r)},r=function(t){n(t),o(t)},i=function(e,n){var o=function(e){var r,i;if(fs.existsSync(e)===!0)for(r=[],fs.readdirSync(e).forEach(function(o){var i=e+"/"+o;t({path:i,name:o})===!0?r.push(i):fs.statSync(rootPath+"/"+i).isDirectory()!==!0&&n(i)}),i=0;i<r.length;i+=1)o(r[i])};FOR_BOX(function(t){o(t.boxName+"/"+e)})},a=function(t){i(t,n)},s=function(t){i(t,o)},c=function(t){i(t,r)},l=function(){void 0!==params&&(void 0!==params.CONFIG&&(EXTEND_DATA({origin:global.CONFIG,extend:params.CONFIG}),browserScript+="EXTEND_DATA({ origin : global.CONFIG, extend : "+stringifyJSONWithFunction(params.CONFIG)+" });\n"),void 0!==params.SERVER_CONFIG&&(EXTEND_DATA({origin:global.SERVER_CONFIG,extend:params.SERVER_CONFIG}),SERVER_CONFIG.rootPath=rootPath),void 0!==params.BROWSER_CONFIG&&(browserScript+="EXTEND_DATA({ origin : global.BROWSER_CONFIG, extend : "+stringifyJSONWithFunction(params.BROWSER_CONFIG)+" });\n")),CONFIG.version=sharedData.version,browserScript+="CONFIG.version = "+CONFIG.version+";\n"},E=function(){var t=UPPERSITE.MODULE("mongolian");UPPERSITE.db=(new t).db(SERVER_CONFIG.dbName),SERVER_CONFIG.isNotRequiringDBAuth!==!0&&UPPERSITE.db.auth(SERVER_CONFIG.dbUsername,SERVER_CONFIG.dbPassword)},f=function(){var t=UPPERSITE.MODULE("uglify-js");browserScript=t.minify(browserScript,{fromString:!0,mangle:!0}).code},d=function(){logoText=fs.readFileSync(rootPath+"/UPPERSITE/LOGO"),browserScript="/* Welcome to JavaScript World! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n*/"+browserScript},r("UPPERSITE/UPPERCASE.JS"),e(),c("COMMON"),a("SERVER"),s("BROWSER"),o("UPPERSITE/BROWSER_FIX.js"),l(),SERVER_CONFIG.isNotUsingDB!==!0&&E(),o("UPPERSITE/BROWSER_INIT.js"),CONFIG.isDevMode!==!0&&f(),d()},startServer=function(){var t,e,n,o,r=require("http"),i=require("https"),a=UPPERSITE.MODULE("socket.io"),s=UPPERSITE.MODULE("formidable").IncomingForm,c=UPPERSITE.MODULE("imagemagick");o=function(t,e){var n,o,r,i,a,l,E,f,d,u,S,P,_,R,I,O,g=t.url,p={},T=t.method.toUpperCase(),h=t.headers;h.ip=t.headers["X-Forwarded-For"],void 0===h.ip&&(h.ip=t.connection.remoteAddress),i=function(t){var e=path.extname(t);return".png"===e?"image/png":".jpg"===e||".jpeg"===e?"image/jpeg":".gif"===e?"image/gif":".js"===e?"text/javascript":".css"===e?"text/css":".txt"===e?"text/plain":".html"===e?"text/html":".swf"===e?"application/x-shockwave-flash":"application/octet-stream"},a=function(t){return"text/javascript"===t?"utf-8":"text/css"===t?"utf-8":"text/plain"===t?"binary":"text/html"===t?"utf-8":"image/png"===t?"binary":"image/jpeg"===t?"binary":"image/gif"===t?"binary":"application/x-shockwave-flash"===t?"binary":"binary"},l=function(){var t=g.indexOf("?");-1!==t&&(o=decodeURI(g.substring(t+1)),g=g.substring(0,t)),n=g.substring(1)},E=function(){var t=n.indexOf("/");-1===t?r=CONFIG.defaultBoxName:(r=n.substring(0,t),void 0!==global[r]&&global[r].type===BOX?n=n.substring(t+1):r=CONFIG.defaultBoxName)},f=function(){return void 0!==t.headers["if-none-match"]||void 0!==t.headers["if-modified-since"]},d=function(t){e.writeHead(302,{Location:t}),e.end()},u=function(){e.statusCode=304,e.end()},S=function(t){var n=t.content,o=t.contentType,r=t.encoding,i=t.isToCache;e.setHeader("Content-Type",o),i===!0&&(e.setHeader("ETag",CONFIG.version),e.setHeader("Last-Modified",new Date(CONFIG.version).toUTCString())),e.statusCode=200,e.end(n,r)},P=function(){S({content:browserScript,contentType:"text/javascript",encoding:"utf-8"})},_=function(){var n=new s,o=[],i={};n.uploadDir="__UPLOAD/"+r+"/__TEMP/",fs.existsSync(rootPath+"/"+n.uploadDir)===!1&&console.log("Not exists folder: "+rootPath+"/"+n.uploadDir),void 0!==global[r]&&fs.existsSync(rootPath+"/"+n.uploadDir)===!0?(n.on("field",function(t,e){i[t]=e}).on("file",function(t,e){o.push({tempPath:e.path,size:e.size,name:e.name,type:e.type,lastModifiedDate:e.lastModifiedDate})}).on("end",function(){var t=global[r].DB("__UPLOAD_FILE"),n=0;EACH(o,function(a){var s=a.tempPath;return a.size>1024*CONFIG.maxUploadFileMB*1024?(e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>errorCode='SIZE'</script>","utf-8"),!1):(EACH(i,function(t,e){""!==t.trim()&&(a[e]=t)}),REMOVE_AT({data:a,key:"tempPath"}),void c.readMetadata(s,function(i,l){var E=function(){t.createData(a,function(t,i){var a=UPPERSITE.MODULE("mv"),c=rootPath+"/__UPLOAD/"+r+"/"+i.id;void 0===t&&a(s,c,function(){n+=1,n===o.length&&(EACH(o,function(t,e){o[e]=PACK_DATA(t)}),e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>fileDataSet="+JSON.stringify(o)+"</script>","utf-8")),console.log("File '"+c+"' ("+i.name+", "+i.size+" byte) uploaded.")})})};void 0!==l.exif?(a.exif=l.exif,c.convert([s,"-auto-orient",s],function(){E()})):E()}))})}).on("error",function(){e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>errorCode='ERROR'</script>","utf-8")}),n.parse(t)):(e.writeHead(200,{"Content-Type":"text/html"}),e.end("<script>errorCode='ERROR'</script>","utf-8"))},R=function(){var t,e,o,s=rootPath+"/"+r+"/WEB/"+n;if(n.length>=7&&"CACHED/"===n.substring(0,7)&&CONFIG.isDevMode!==!0){if(f()===!0)return void u();o=!0}n.length>=9&&"__UPLOAD/"===n.substring(0,9)?(n=n.substring(9),I()):void 0!==p[s]?S(p[s]):(t=i(n),e=a(t),fs.exists(s,function(n){n===!0?fs.readFile(s,e,function(n,r){null!==n?O():S(p[s]={content:r,contentType:t,encoding:e,isToCache:o})}):O()}))},I=function(){var t;f()===!0?u():(t=rootPath+"/__UPLOAD/"+r+"/"+n,fs.exists(t,function(e){e===!0?fs.readFile(t,"binary",function(e,n){null!==e?O():fs.stat(t,function(t,e){null!==t?O():S({content:n,contentType:"application/octet-stream",encoding:"binary",lastModifiedTime:e.mtime})})}):O()}))},O=function(){fs.exists(CONFIG.defaultBoxName+"/ERROR.html",function(t){t===!0?fs.readFile(CONFIG.defaultBoxName+"/ERROR.html","utf-8",function(t,n){null===t&&(e.writeHead(500,{"Content-Type":"text/html"}),e.end(n,"utf-8"))}):fs.readFile("UPPERSITE/ERROR.html","utf-8",function(t,n){null===t&&(e.writeHead(500,{"Content-Type":"text/html"}),e.end(n,"utf-8"))})})},l(),"POST"===T?(E(),"__UPLOAD"===n?_():(o="",t.on("data",function(t){o+=t}),t.on("end",function(){void 0!==global[r]&&void 0!==global[r].REQUEST&&void 0!==global[r].REQUEST.checkURI&&global[r].REQUEST.checkURI({uri:n,method:T,paramStr:o,headers:h},{response:S,serveErrorPage:O})===!0||R(r)}))):"GET"===T?"__SCRIPT"===n?P():(E(),""===n&&(n="index.html"),void 0!==global[r]&&void 0!==global[r].REQUEST&&void 0!==global[r].REQUEST.checkURI&&global[r].REQUEST.checkURI({uri:n,method:T,paramStr:o,headers:h},{response:S,serveErrorPage:O})===!0||R(r)):("PUT"===T||"DELETE"===T)&&(E(),void 0!==global[r]&&void 0!==global[r].REQUEST&&void 0!==global[r].REQUEST.checkURI&&global[r].REQUEST.checkURI({uri:n,method:T,paramStr:o,headers:h},{response:S,serveErrorPage:O})===!0||R(r))},t=r.createServer(o).listen(CONFIG.port),void 0!==SERVER_CONFIG.securedPort&&(e=i.createServer({key:fs.readFileSync(rootPath+"/"+SERVER_CONFIG.securedKeyFileName),cert:fs.readFileSync(rootPath+"/"+SERVER_CONFIG.securedCrtFileName)},o).listen(SERVER_CONFIG.securedPort)),n=a.listen(t),CONFIG.isDevMode===!0?n.set("log level",2):n.set("log level",1),n.configure(function(){n.set("flash policy port",void 0===CONFIG.flashPolicyServerPort?CONFIG.port+1955:CONFIG.flashPolicyServerPort),n.set("transports",CONFIG.transports)}),CONNS.type.socketPack=n.sockets,OBJECT.init(),FOR_BOX(function(t){void 0!==t.MAIN&&t.MAIN()}),console.log("[UPPERSITE] "+CONFIG.defaultTitle+" WORKER BOOTed. => http://localhost:"+CONFIG.port+(void 0!==SERVER_CONFIG.securedPort?" SECUREd => https://localhost:"+SERVER_CONFIG.securedPort:""))},startREPL=function(){DELAY(1,function(){var t=require("repl");t.start({prompt:"UPPERSITE> ",input:process.stdin,output:process.stdout})})},loadAll(),startServer(),SERVER_CONFIG.isUsingREPL===!0&&startREPL()},fork=function(){cluster.fork().send({version:version})};work({version:version})};